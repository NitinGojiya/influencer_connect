<%= form_with(model: @campaign, local: true, class: "space-y-6") do |f| %>

  <!-- Global Errors -->
  <% if @campaign.errors.any? %>
    <div class="mb-4 rounded-2xl bg-red-50 border border-red-200 p-4">
      <h2 class="text-red-700 font-semibold mb-2">
        <%= pluralize(@campaign.errors.count, "error") %> prevented this campaign from being saved:
      </h2>
      <ul class="list-disc pl-5 text-red-600 text-sm">
        <% @campaign.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Content Type -->
  <div>
    <%= f.label :content_type, "Content Type", class: "block text-sm font-medium mb-1" %>
    <%= f.select :content_type,
        ["Instagram Reel", "Instagram Story", "Instagram Carousel", "TikTok Video", "YouTube: Dedicated Review", "YouTube: Integrated Mention", "Blog Post", "Podcast Ad Read", "Other"],
        { prompt: "Select a content type" },
        class: "w-full rounded-2xl border-gray-300 dark:border-gray-700 px-4 py-2.5" %>
    <% if @campaign.errors[:content_type].any? %>
      <p class="text-sm text-red-600 mt-1"><%= @campaign.errors[:content_type].first %></p>
    <% end %>
  </div>

  <!-- Deliverable Details -->
  <div>
    <%= f.label :deliverable_details, "Deliverable Details", class: "block text-sm font-medium mb-1" %>
    <%= f.text_field :deliverable_details, class: "w-full rounded-2xl border-gray-300 dark:border-gray-700 px-4 py-2.5", placeholder: "e.g., 1 Reel + 2 Stories" %>
  </div>

  <!-- Key Messages -->
  <div>
    <%= f.label :key_messages, "Key Messages", class: "block text-sm font-medium mb-1" %>
    <%= f.text_area :key_messages, rows: 4, class: "w-full rounded-2xl border-gray-300 dark:border-gray-700 px-4 py-2.5", placeholder: "Comma-separated points, e.g., 100% organic, safe for sensitive skin, use code SKIN15" %>
  </div>

  <!-- Tags Required -->
  <div>
    <%= f.label :tags_require, "Tags Required (handles & hashtags)", class: "block text-sm font-medium mb-1" %>
    <%= f.text_field :tags_require, class: "w-full rounded-2xl border-gray-300 dark:border-gray-700 px-4 py-2.5", placeholder: "e.g., @BrandName, #GlowWithNature, #OrganicBeauty" %>
  </div>

  <!-- Creative Guidelines -->
  <div>
    <%= f.label :creative_guidelines, "Creative Guidelines", class: "block text-sm font-medium mb-1" %>
    <%= f.text_area :creative_guidelines, rows: 4, class: "w-full rounded-2xl border-gray-300 dark:border-gray-700 px-4 py-2.5", placeholder: "Tone, aesthetic, do’s & don’ts" %>
  </div>

  <!-- City Dropdown -->
  <div>
    <%# render 'shared/city_dropdown' %>
  </div>
  <div class="relative w-full max-w-md">
    <details class="relative">
      <summary class="cursor-pointer block w-full bg-white border border-gray-300 text-gray-700 py-3 px-4 rounded-full leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
        <span id="selected-city"><%= params[:city_name].presence || "Select or type city" %></span>
      </summary>
      <div class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
        <!-- Search or type input -->
        <input
          type="text"
          id="city-search"
          placeholder="Search or type city..."
          class="w-full px-3 py-2 border-b border-gray-200 focus:outline-none"
          onkeyup="filterCities()"
        >
        <!-- City list -->
        <ul id="city-list">
          <% City.order(:name).each do |city| %>
            <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer"
                data-id="<%= city.id %>"
                onclick="selectCity(this)">
              <%= city.name %>
            </li>
          <% end %>
        </ul>
      </div>
    </details>

    <!-- Hidden field to submit either city_id or new city_name -->
    <%= hidden_field_tag :city_id, params[:city_id], id: "city_id_field" %>
    <%= text_field_tag :city_name, params[:city_name], id: "city_name_field", class: "hidden" %>
  </div>

  <!-- these js for testing change to stimulus -->
  <script>
    function filterCities() {
      const input = document.getElementById('city-search');
      const filter = input.value.toLowerCase();
      const ul = document.getElementById('city-list');
      const li = ul.getElementsByTagName('li');

      for (let i = 0; i < li.length; i++) {
        const text = li[i].textContent || li[i].innerText;
        li[i].style.display = text.toLowerCase().includes(filter) ? "" : "none";
      }

      // Update hidden field for new city
      document.getElementById('city_name_field').value = input.value;
      document.getElementById('city_id_field').value = ""; // clear selected city_id
      document.getElementById('selected-city').innerText = input.value || "Select or type city";
    }

    function selectCity(element) {
      document.getElementById('selected-city').innerText = element.innerText;
      document.getElementById('city_id_field').value = element.dataset.id;
      document.getElementById('city_name_field').value = ""; // clear typed city_name
      element.closest('details').removeAttribute('open');
    }
  </script>


  <!-- Approval Deadline & Posting Start Date -->
  <div class="grid sm:grid-cols-2 gap-4">
    <div>
      <%= f.label :approval_deadline, "Approval Deadline", class: "block text-sm font-medium mb-1" %>
      <%= f.datetime_local_field :approval_deadline, class: "w-full rounded-2xl border-gray-300 dark:border-gray-700 px-4 py-2.5" %>
      <% if @campaign.errors[:approval_deadline].any? %>
        <p class="text-sm text-red-600 mt-1"><%= @campaign.errors[:approval_deadline].first %></p>
      <% end %>
    </div>
    <div>
      <%= f.label :posting_start_date, "Posting Start Date", class: "block text-sm font-medium mb-1" %>
      <%= f.datetime_local_field :posting_start_date, class: "w-full rounded-2xl border-gray-300 dark:border-gray-700 px-4 py-2.5" %>
      <% if @campaign.errors[:posting_start_date].any? %>
        <p class="text-sm text-red-600 mt-1"><%= @campaign.errors[:posting_start_date].first %></p>
      <% end %>
    </div>
  </div>

  <!-- Actions -->
  <div class="flex gap-3 pt-2">
    <%= f.submit  class: "inline-flex items-center justify-center rounded-2xl bg-blue-600 hover:bg-blue-700 px-5 py-2.5 text-white font-medium shadow-soft" %>
    <%= link_to "Reset", new_campaign_path, class: "inline-flex items-center justify-center rounded-2xl border border-gray-300 dark:border-gray-700 px-5 py-2.5 font-medium hover:bg-gray-100 dark:hover:bg-gray-700/50" %>
    <%= link_to "Back", campaigns_path, class: "px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200" %>
  </div>

<% end %>
