<!-- app/views/conversations/show.html.erb -->
<%= turbo_frame_tag "chat_window" do %>
  <div class="flex flex-col h-full w-full max-h-[700px] border-l border-gray-300">

    <%# Subscribe to turbo stream for live updates %>
    <%= turbo_stream_from "messages_#{@conversation.id}_#{@user.id}" %>

    <!-- Chat Header -->
    <% other_user = (@conversation.sender == @user ? @conversation.receiver : @conversation.sender) %>
    <div class="p-4 border-b border-gray-300 bg-white flex items-center">
      <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
        <% initial = if other_user&.profile&.full_name.present?
                other_user.profile.full_name[0]
              elsif other_user.email_address.present?
                other_user.email_address[0]
              else
                "N"
              end %>

       <%= image_tag( other_user&.profile&.profile_pic&.attached? ?
                      url_for(other_user.profile.profile_pic.variant(resize_to_fill: [150, 150]).processed) :
                      "https://placehold.co/100x100/A020F0/FFFFFF?text=#{initial}", alt: "photo", class: "rounded-full") %>
      </div>
      <h2 class="ml-3 font-semibold text-black"><%= other_user.email_address %></h2>
    </div>

    <!-- Messages -->
    <div id="messages"
         class="flex-1 overflow-y-auto p-4 space-y-2"
         data-controller="autoscroll">
      <%= render partial: 'messages/message', collection: @messages, as: :message %>
    </div>

    <!-- Message Input -->
    <%= render "messages/form", conversation: @conversation, message: @message %>
  </div>
<% end %>
